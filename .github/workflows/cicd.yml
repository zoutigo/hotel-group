name: Full CI process for Symfony 5 / React

on: [push]



jobs:

  backend :
    name: Running functional and unit test
    runs-on: ubuntu-20.04

    strategy:
      fail-fast: true
      matrix:
        php-versions: ['8']

    env: 
      MYSQL_ROOT_PASS : superSecr3t
      MYSQL_USER : app_user
      MYSQL_PASS : t3rceS
      MYSQL_DB : symfony_project_2021
      DB_DATABASE: test_db
      DB_USER: root
      DB_PASSWORD: password
      APP_ENV : test
    container: ubuntu
    services:
        mydb:
          image: mysql:8
          env:
            MYSQL_ROOT_PASSWORD: ${{env.DB_PASSWORD}}
          options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=5

    steps: 
        - name: Verify MySQL connection from container 
          run: |
            apt-get update
            apt-get install -y mysql-client
            mysql --host mydb -u${{env.DB_USER}} -p${{env.DB_PASSWORD}}  -e 'CREATE DATABASE ${{env.DB_DATABASE }};'
            mysql --host mydb -u${{env.DB_USER}} -p${{env.DB_PASSWORD}} -e "SHOW DATABASES"
      # â€”â€” Setup Github actions ğŸ™ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      ## https://github.com/actions/checkout (official)
        - name: Checkout
          uses: actions/checkout@v2

       ## https://github.com/shivammathur/setup-php (community)
        - name: Setup PHP, extensions and composer with shivammathur/setup-php
          uses: shivammathur/setup-php@v2
          with:
            php-version: ${{ matrix.php-versions }}
            extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, iconv, json, mbstring, mysqli
          env:
            update: true

        - name: Check PHP Version
          run: php -v

      ## â€”â€” Php Coding standards âœ¨ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        - name: Coding standards checks (php_codesniffer + php-cs-fixer)
          run: make cs
          if: matrix.php-versions == '8.0'

      ## â€”â€” Composer ğŸ§™â€ï¸ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        - name: Update composer
          run: composer update

        - name: Validate composer.json and composer.lock
          run: composer validate --no-check-all --no-check-publish

        - name: Get composer cache directory
          id: composer-cache
          run: echo "::set-output name=dir::$(composer config cache-files-dir)"

        - name: Cache composer dependencies
          uses: actions/cache@v1
          with:
            path: ${{ steps.composer-cache.outputs.dir }}
            key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
            restore-keys: ${{ runner.os }}-composer-

        - name: Install Composer dependencies
          run: composer install --no-progress --prefer-dist --optimize-autoloader

       
      
        ## â€”â€” Symfony ğŸµ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    
        - name: Check Symfony requirements
          run: vendor/bin/requirements-checker

  
      ## run tests

        - name: Run Migration && Load Fixtures
          env:
            APP_ENV: test
            DATABASE_URL : mysql://${DB_USER}:${DB_PASSWORD}@mydb:3306/${DB_DATABASE}?serverVersion=8&charset=utf8mb4
          run: |
            php bin/console doctrine:schema:update --env=test --force || echo "No migrations found or schema update failed"
            php bin/console doctrine:migrations:migrate --env=test || echo "No migrations found or migration failed"
            php bin/console doctrine:fixtures:load --no-interaction
         

        ## â€”â€” JWT ğŸ’« â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        - name: Generate the SSL keys
          run: bin/console lexik:jwt:generate-keypair

        ## â€”â€” NPM ğŸ± â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        - name: npm install
          uses: actions/setup-node@v2
          with:
            node-version: '16.3'
            #registry-url: npm.fontawesome.com
        - run: npm install
            #env:
          #NODE_AUTH_TOKEN: ${{ secrets.FONTAWESOME_NPM_AUTH_TOKEN }}

        - name: npm run build
          run: npm run build

                ## â€”â€” Setup MySql â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    
        - name: Set up MySQL
          run: |
            sudo /etc/init.d/mysql start
            mysql -e 'CREATE DATABASE ${{env.DB_DATABASE }};' -u${{env.DB_USER }} -p${{ env.DB_PASSWORD }}
            mysql -e 'SHOW DATABASES;' -u${{env.DB_USER}} -p${{env.DB_PASSWORD}}

